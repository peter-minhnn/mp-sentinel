name: MP Sentinel Code Guard (Anthropic Claude)
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node & Cache
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci 

      - name: Build
        run: npm run build

      - name: Run Audit with Anthropic Claude
        env:
          # Anthropic Configuration
          AI_PROVIDER: anthropic
          AI_MODEL: claude-sonnet-4.5  # Best for coding and agents
          # AI_MODEL: claude-opus-4  # Most capable, for complex tasks
          # AI_MODEL: claude-3-5-sonnet  # Previous generation
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          
          # Optional: Fine-tune behavior
          AI_TEMPERATURE: 0.2
          AI_MAX_TOKENS: 8192
          
          # GitHub integration
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_BRANCH: origin/${{ github.base_ref }}
        run: npx mp-sentinel --target-branch $TARGET_BRANCH

# Setup Instructions:
# 1. Get Anthropic API key: https://console.anthropic.com/
# 2. Add to GitHub Secrets: Settings → Secrets → Actions → New repository secret
#    Name: ANTHROPIC_API_KEY
#    Value: sk-ant-...
# 3. Rename this file to: .github/workflows/audit.yml
# 4. Commit and push
